<!DOCTYPE html>
<!--
 Copyright 2021 Red Hat, Inc

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<html>
<head>
<title>server.go</title>
<meta charset="utf-8"/>
<style type="text/css">body {
    background: rgb(225, 225, 225);
    margin: 0px;
    padding: 0px;
}

#docgo p {
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo div {
    display: inline;
}

#docgo #background {
    position: fixed;
    top: 0; left: 525px; right: 0; bottom: 0;
    background: rgb(47, 47, 47);
    border-left: 1px solid #e5e5ee;
    z-index: -1;
}

#docgo .keyword {
    color: rgb(250, 200, 100);
}

#docgo .literal {
    color: rgb(140, 190, 100);
}

#docgo .ident {
    color: white;
}

#docgo .operator {
    color: white;
}

#docgo .comment {
}

#docgo h1, h2, h3, h4, h5 {
    text-align: left;
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo h1 {
    margin-top: 40px;
}

#docgo .doc {
    vertical-align: top;
    font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
    font-size: 15px;
    line-height: 22px;
    color: black;
    min-width: 450px;
    max-width: 450px;
    padding-top: 10px;
    padding-right: 25px;
    padding-bottom: 1px;
    padding-left: 50px;
    overflow-x: hidden;
}

#docgo .code {
    min-width: 650px;
    max-width: 650px;
    padding-left: 25px;
    padding-right: 15px;
    border-left: 1px;
    overflow-x: hidden;
    vertical-align: top;
}

#docgo .code pre code  {
    font-size: 12px;
    line-height: 18px;
    font-family: Menlo, Monaco, Consolas, "Lucida Console", monospace;
    color: rgb(120, 120, 120);
}
</style>
</head>
<body>
<div id="docgo">
  <div id="background"></div>
  <table>
    <thead><tr><th class="doc"><h1>server.go</h1></th><th class="code"></th></tr></thead>
    <tbody>
      
      <tr class="section">
	<td class="doc"></td>
	<td class="code"><pre><code><div class="comment">/*
Copyright Â© 2020 Red Hat, Inc.

Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

	http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/</div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Package server contains implementation of REST API server (HTTPServer) for
the Insights results smart proxy service. In current version, the following</p>

<p>Please note that API_PREFIX is part of server configuration (see
Configuration). Also please note that JSON format is used to transfer data
between server and clients.</p>
</td>
	<td class="code"><pre><code><div class="keyword">package</div> <div class="ident">server</div><div class="operator"></div>

<div class="keyword">import</div> <div class="operator">(</div>
	<div class="literal">&#34;context&#34;</div><div class="operator"></div>
	<div class="literal">&#34;encoding/json&#34;</div><div class="operator"></div>
	<div class="literal">&#34;fmt&#34;</div><div class="operator"></div>
	<div class="literal">&#34;io/ioutil&#34;</div><div class="operator"></div>
	<div class="literal">&#34;net/http&#34;</div><div class="operator"></div>
	<div class="literal">&#34;net/url&#34;</div><div class="operator"></div>
	<div class="literal">&#34;strings&#34;</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>we just have to import this package in order to expose pprof
interface in debug mode
disable &quot;G108 (CWE-): Profiling endpoint is automatically exposed on /debug/pprof&quot;</p>

<h1>nosec G108</h1>
</td>
	<td class="code"><pre><code>	<div class="ident">_</div> <div class="literal">&#34;net/http/pprof&#34;</div><div class="operator"></div>
	<div class="literal">&#34;path/filepath&#34;</div><div class="operator"></div>

	<div class="literal">&#34;github.com/RedHatInsights/insights-content-service/groups&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/RedHatInsights/insights-operator-utils/responses&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/RedHatInsights/insights-operator-utils/types&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/gorilla/handlers&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/gorilla/mux&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/rs/zerolog/log&#34;</div><div class="operator"></div>

	<div class="ident">httputils</div> <div class="literal">&#34;github.com/RedHatInsights/insights-operator-utils/http&#34;</div><div class="operator"></div>
	<div class="ident">ira_server</div> <div class="literal">&#34;github.com/RedHatInsights/insights-results-aggregator/server&#34;</div><div class="operator"></div>

	<div class="literal">&#34;github.com/RedHatInsights/insights-results-smart-proxy/content&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/RedHatInsights/insights-results-smart-proxy/services&#34;</div><div class="operator"></div>

	<div class="ident">proxy_types</div> <div class="literal">&#34;github.com/RedHatInsights/insights-results-smart-proxy/types&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>HTTPServer is an implementation of Server interface</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">HTTPServer</div> <div class="keyword">struct</div> <div class="operator">{</div>
	<div class="ident">Config</div>         <div class="ident">Configuration</div><div class="operator"></div>
	<div class="ident">ServicesConfig</div> <div class="ident">services</div><div class="operator">.</div><div class="ident">Configuration</div><div class="operator"></div>
	<div class="ident">GroupsChannel</div>  <div class="keyword">chan</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">groups</div><div class="operator">.</div><div class="ident">Group</div><div class="operator"></div>
	<div class="ident">Serv</div>           <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Server</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>RequestModifier is a type of function which modifies request when proxying</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">RequestModifier</div> <div class="keyword">func</div><div class="operator">(</div><div class="ident">request</div> <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Request</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Request</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ResponseModifier is a type of function which modifies response when proxying</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">ResponseModifier</div> <div class="keyword">func</div><div class="operator">(</div><div class="ident">response</div> <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Response</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Response</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ProxyOptions alters behaviour of proxy server for each endpoint.
For example, you can set custom request and response modifiers</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">ProxyOptions</div> <div class="keyword">struct</div> <div class="operator">{</div>
	<div class="ident">RequestModifiers</div>  <div class="operator">[</div><div class="operator">]</div><div class="ident">RequestModifier</div><div class="operator"></div>
	<div class="ident">ResponseModifiers</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ResponseModifier</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>New function constructs new implementation of Server interface.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">New</div><div class="operator">(</div><div class="ident">config</div> <div class="ident">Configuration</div><div class="operator">,</div> <div class="ident">servicesConfig</div> <div class="ident">services</div><div class="operator">.</div><div class="ident">Configuration</div><div class="operator">,</div> <div class="ident">groupsChannel</div> <div class="keyword">chan</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">groups</div><div class="operator">.</div><div class="ident">Group</div><div class="operator">)</div> <div class="operator">*</div><div class="ident">HTTPServer</div> <div class="operator">{</div>
	<div class="keyword">return</div> <div class="operator">&amp;</div><div class="ident">HTTPServer</div><div class="operator">{</div>
		<div class="ident">Config</div><div class="operator">:</div>         <div class="ident">config</div><div class="operator">,</div>
		<div class="ident">ServicesConfig</div><div class="operator">:</div> <div class="ident">servicesConfig</div><div class="operator">,</div>
		<div class="ident">GroupsChannel</div><div class="operator">:</div>  <div class="ident">groupsChannel</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>mainEndpoint method handles requests to the main endpoint.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="operator">*</div><div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">mainEndpoint</div><div class="operator">(</div><div class="ident">writer</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">ResponseWriter</div><div class="operator">,</div> <div class="ident">_</div> <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Request</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">responses</div><div class="operator">.</div><div class="ident">SendOK</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">responses</div><div class="operator">.</div><div class="ident">BuildOkResponse</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">responseDataError</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Initialize method performs the server initialization, including
registration of all handlers.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="operator">*</div><div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">Initialize</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">Handler</div> <div class="operator">{</div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;Initializing HTTP server at &#39;%s&#39;&#34;</div><div class="operator">,</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">Config</div><div class="operator">.</div><div class="ident">Address</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">router</div> <div class="operator">:=</div> <div class="ident">mux</div><div class="operator">.</div><div class="ident">NewRouter</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">StrictSlash</div><div class="operator">(</div><div class="ident">true</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">router</div><div class="operator">.</div><div class="ident">Use</div><div class="operator">(</div><div class="ident">httputils</div><div class="operator">.</div><div class="ident">LogRequest</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">apiPrefix</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">Config</div><div class="operator">.</div><div class="ident">APIPrefix</div><div class="operator"></div>

	<div class="ident">metricsURL</div> <div class="operator">:=</div> <div class="ident">apiPrefix</div> <div class="operator">&#43;</div> <div class="ident">MetricsEndpoint</div><div class="operator"></div>
	<div class="ident">openAPIURL</div> <div class="operator">:=</div> <div class="ident">apiPrefix</div> <div class="operator">&#43;</div> <div class="ident">filepath</div><div class="operator">.</div><div class="ident">Base</div><div class="operator">(</div><div class="ident">server</div><div class="operator">.</div><div class="ident">Config</div><div class="operator">.</div><div class="ident">APISpecFile</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>enable authentication, but only if it is setup in configuration</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">Config</div><div class="operator">.</div><div class="ident">Auth</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>we have to enable authentication for all endpoints,
including endpoints for Prometheus metrics and OpenAPI
specification, because there is not single prefix of other
REST API calls. The special endpoints needs to be handled in
middleware which is not optimal</p>
</td>
	<td class="code"><pre><code>		<div class="ident">noAuthURLs</div> <div class="operator">:=</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div>
			<div class="ident">metricsURL</div><div class="operator">,</div>
			<div class="ident">openAPIURL</div><div class="operator">,</div>
			<div class="ident">metricsURL</div> <div class="operator">&#43;</div> <div class="literal">&#34;?&#34;</div><div class="operator">,</div> <div class="comment">// to be able to test using Frisby</div>
			<div class="ident">openAPIURL</div> <div class="operator">&#43;</div> <div class="literal">&#34;?&#34;</div><div class="operator">,</div> <div class="comment">// to be able to test using Frisby</div>
		<div class="operator">}</div><div class="operator"></div>
		<div class="ident">router</div><div class="operator">.</div><div class="ident">Use</div><div class="operator">(</div><div class="keyword">func</div><div class="operator">(</div><div class="ident">next</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">Handler</div><div class="operator">)</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">Handler</div> <div class="operator">{</div> <div class="keyword">return</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">Authentication</div><div class="operator">(</div><div class="ident">next</div><div class="operator">,</div> <div class="ident">noAuthURLs</div><div class="operator">)</div> <div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">Config</div><div class="operator">.</div><div class="ident">EnableCORS</div> <div class="operator">{</div>
		<div class="ident">headersOK</div> <div class="operator">:=</div> <div class="ident">handlers</div><div class="operator">.</div><div class="ident">AllowedHeaders</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div>
			<div class="literal">&#34;Content-Type&#34;</div><div class="operator">,</div>
			<div class="literal">&#34;Content-Length&#34;</div><div class="operator">,</div>
			<div class="literal">&#34;Accept-Encoding&#34;</div><div class="operator">,</div>
			<div class="literal">&#34;X-CSRF-Token&#34;</div><div class="operator">,</div>
			<div class="literal">&#34;Authorization&#34;</div><div class="operator">,</div>
		<div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">originsOK</div> <div class="operator">:=</div> <div class="ident">handlers</div><div class="operator">.</div><div class="ident">AllowedOrigins</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="literal">&#34;*&#34;</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">methodsOK</div> <div class="operator">:=</div> <div class="ident">handlers</div><div class="operator">.</div><div class="ident">AllowedMethods</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div>
			<div class="ident">http</div><div class="operator">.</div><div class="ident">MethodPost</div><div class="operator">,</div>
			<div class="ident">http</div><div class="operator">.</div><div class="ident">MethodGet</div><div class="operator">,</div>
			<div class="ident">http</div><div class="operator">.</div><div class="ident">MethodOptions</div><div class="operator">,</div>
			<div class="ident">http</div><div class="operator">.</div><div class="ident">MethodPut</div><div class="operator">,</div>
			<div class="ident">http</div><div class="operator">.</div><div class="ident">MethodDelete</div><div class="operator">,</div>
		<div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">credsOK</div> <div class="operator">:=</div> <div class="ident">handlers</div><div class="operator">.</div><div class="ident">AllowCredentials</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">corsMiddleware</div> <div class="operator">:=</div> <div class="ident">handlers</div><div class="operator">.</div><div class="ident">CORS</div><div class="operator">(</div><div class="ident">originsOK</div><div class="operator">,</div> <div class="ident">headersOK</div><div class="operator">,</div> <div class="ident">methodsOK</div><div class="operator">,</div> <div class="ident">credsOK</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">router</div><div class="operator">.</div><div class="ident">Use</div><div class="operator">(</div><div class="ident">corsMiddleware</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">server</div><div class="operator">.</div><div class="ident">addEndpointsToRouter</div><div class="operator">(</div><div class="ident">router</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">router</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Start method starts HTTP or HTTPS server.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="operator">*</div><div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">Start</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">address</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">Config</div><div class="operator">.</div><div class="ident">Address</div><div class="operator"></div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;Starting HTTP server at &#39;%s&#39;&#34;</div><div class="operator">,</div> <div class="ident">address</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">router</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">Initialize</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">server</div><div class="operator">.</div><div class="ident">Serv</div> <div class="operator">=</div> <div class="operator">&amp;</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Server</div><div class="operator">{</div><div class="ident">Addr</div><div class="operator">:</div> <div class="ident">address</div><div class="operator">,</div> <div class="ident">Handler</div><div class="operator">:</div> <div class="ident">router</div><div class="operator">}</div><div class="operator"></div>
	<div class="keyword">var</div> <div class="ident">err</div> <div class="ident">error</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">Config</div><div class="operator">.</div><div class="ident">UseHTTPS</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">Serv</div><div class="operator">.</div><div class="ident">ListenAndServeTLS</div><div class="operator">(</div><div class="literal">&#34;server.crt&#34;</div><div class="operator">,</div> <div class="literal">&#34;server.key&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">Serv</div><div class="operator">.</div><div class="ident">ListenAndServe</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">&amp;&amp;</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">ErrServerClosed</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Unable to start HTTP/S server&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Stop method stops server's execution.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="operator">*</div><div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">Stop</div><div class="operator">(</div><div class="ident">ctx</div> <div class="ident">context</div><div class="operator">.</div><div class="ident">Context</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="keyword">return</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">Serv</div><div class="operator">.</div><div class="ident">Shutdown</div><div class="operator">(</div><div class="ident">ctx</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>modifyRequest function modifies HTTP request during proxying it to another
service.
TODO: move to utils?</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">modifyRequest</div><div class="operator">(</div><div class="ident">requestModifiers</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">RequestModifier</div><div class="operator">,</div> <div class="ident">request</div> <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Request</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Request</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">modifier</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">requestModifiers</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="ident">err</div> <div class="ident">error</div><div class="operator"></div>
		<div class="ident">request</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">modifier</div><div class="operator">(</div><div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">request</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>modifyResponse function modifies HTTP response returned by another service
during proxying.
TODO: move to utils?</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">modifyResponse</div><div class="operator">(</div><div class="ident">responseModifiers</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">ResponseModifier</div><div class="operator">,</div> <div class="ident">response</div> <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Response</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Response</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">modifier</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">responseModifiers</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="ident">err</div> <div class="ident">error</div><div class="operator"></div>
		<div class="ident">response</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">modifier</div><div class="operator">(</div><div class="ident">response</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">response</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>proxyTo method constructs proxy function to proxy request to another
service.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">proxyTo</div><div class="operator">(</div><div class="ident">baseURL</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">options</div> <div class="operator">*</div><div class="ident">ProxyOptions</div><div class="operator">)</div> <div class="keyword">func</div><div class="operator">(</div><div class="ident">http</div><div class="operator">.</div><div class="ident">ResponseWriter</div><div class="operator">,</div> <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Request</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">return</div> <div class="keyword">func</div><div class="operator">(</div><div class="ident">writer</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">ResponseWriter</div><div class="operator">,</div> <div class="ident">request</div> <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Request</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">if</div> <div class="ident">options</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="keyword">var</div> <div class="ident">err</div> <div class="ident">error</div><div class="operator"></div>
			<div class="ident">request</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">modifyRequest</div><div class="operator">(</div><div class="ident">options</div><div class="operator">.</div><div class="ident">RequestModifiers</div><div class="operator">,</div> <div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
				<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
				<div class="keyword">return</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Handling response as a proxy&#34;</div><div class="operator">)</div><div class="operator"></div>

		<div class="ident">endpointURL</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">composeEndpoint</div><div class="operator">(</div><div class="ident">baseURL</div><div class="operator">,</div> <div class="ident">request</div><div class="operator">.</div><div class="ident">RequestURI</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;Error during endpoint %s URL parsing&#34;</div><div class="operator">,</div> <div class="ident">request</div><div class="operator">.</div><div class="ident">RequestURI</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">client</div> <div class="operator">:=</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">Client</div><div class="operator">{</div><div class="operator">}</div><div class="operator"></div>
		<div class="ident">req</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">NewRequest</div><div class="operator">(</div><div class="ident">request</div><div class="operator">.</div><div class="ident">Method</div><div class="operator">,</div> <div class="ident">endpointURL</div><div class="operator">.</div><div class="ident">String</div><div class="operator">(</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">request</div><div class="operator">.</div><div class="ident">Body</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">panic</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">copyHeader</div><div class="operator">(</div><div class="ident">request</div><div class="operator">.</div><div class="ident">Header</div><div class="operator">,</div> <div class="ident">req</div><div class="operator">.</div><div class="ident">Header</div><div class="operator">)</div><div class="operator"></div>

		<div class="ident">response</div><div class="operator">,</div> <div class="ident">body</div><div class="operator">,</div> <div class="ident">successful</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">sendRequest</div><div class="operator">(</div><div class="ident">client</div><div class="operator">,</div> <div class="ident">req</div><div class="operator">,</div> <div class="ident">options</div><div class="operator">,</div> <div class="ident">writer</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="operator">!</div><div class="ident">successful</div> <div class="operator">{</div>
			<div class="keyword">return</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Maybe this code should be on responses.SendRaw or something like that</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">responses</div><div class="operator">.</div><div class="ident">Send</div><div class="operator">(</div><div class="ident">response</div><div class="operator">.</div><div class="ident">StatusCode</div><div class="operator">,</div> <div class="ident">writer</div><div class="operator">,</div> <div class="ident">body</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;Error writing the response&#34;</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">sendRequest</div><div class="operator">(</div>
	<div class="ident">client</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">Client</div><div class="operator">,</div> <div class="ident">req</div> <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Request</div><div class="operator">,</div> <div class="ident">options</div> <div class="operator">*</div><div class="ident">ProxyOptions</div><div class="operator">,</div> <div class="ident">writer</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">ResponseWriter</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Response</div><div class="operator">,</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">byte</div><div class="operator">,</div> <div class="ident">bool</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Debug</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;Connecting to %s&#34;</div><div class="operator">,</div> <div class="ident">req</div><div class="operator">.</div><div class="ident">RequestURI</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">response</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">client</div><div class="operator">.</div><div class="ident">Do</div><div class="operator">(</div><div class="ident">req</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;Error during retrieve of %s&#34;</div><div class="operator">,</div> <div class="ident">req</div><div class="operator">.</div><div class="ident">RequestURI</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">options</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="ident">err</div> <div class="ident">error</div><div class="operator"></div>
		<div class="ident">response</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">modifyResponse</div><div class="operator">(</div><div class="ident">options</div><div class="operator">.</div><div class="ident">ResponseModifiers</div><div class="operator">,</div> <div class="ident">response</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">false</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">body</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">ioutil</div><div class="operator">.</div><div class="ident">ReadAll</div><div class="operator">(</div><div class="ident">response</div><div class="operator">.</div><div class="ident">Body</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;Error while retrieving content from request to %s&#34;</div><div class="operator">,</div> <div class="ident">req</div><div class="operator">.</div><div class="ident">RequestURI</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">response</div><div class="operator">,</div> <div class="ident">body</div><div class="operator">,</div> <div class="ident">true</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">composeEndpoint</div><div class="operator">(</div><div class="ident">baseEndpoint</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">currentEndpoint</div> <div class="ident">string</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">url</div><div class="operator">.</div><div class="ident">URL</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">endpoint</div> <div class="operator">:=</div> <div class="ident">strings</div><div class="operator">.</div><div class="ident">TrimPrefix</div><div class="operator">(</div><div class="ident">currentEndpoint</div><div class="operator">,</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">Config</div><div class="operator">.</div><div class="ident">APIPrefix</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">url</div><div class="operator">.</div><div class="ident">Parse</div><div class="operator">(</div><div class="ident">baseEndpoint</div> <div class="operator">&#43;</div> <div class="ident">endpoint</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">copyHeader</div><div class="operator">(</div><div class="ident">srcHeaders</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">Header</div><div class="operator">,</div> <div class="ident">dstHeaders</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">Header</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">for</div> <div class="ident">headerKey</div><div class="operator">,</div> <div class="ident">headerValues</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">srcHeaders</div> <div class="operator">{</div>
		<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">value</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">headerValues</div> <div class="operator">{</div>
			<div class="ident">dstHeaders</div><div class="operator">.</div><div class="ident">Add</div><div class="operator">(</div><div class="ident">headerKey</div><div class="operator">,</div> <div class="ident">value</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>readClusterIDsForOrgID reads the list of clusters for a given
organization from aggregator</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">readClusterIDsForOrgID</div><div class="operator">(</div><div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">aggregatorURL</div> <div class="operator">:=</div> <div class="ident">httputils</div><div class="operator">.</div><div class="ident">MakeURLToEndpoint</div><div class="operator">(</div>
		<div class="ident">server</div><div class="operator">.</div><div class="ident">ServicesConfig</div><div class="operator">.</div><div class="ident">AggregatorBaseEndpoint</div><div class="operator">,</div>
		<div class="ident">ira_server</div><div class="operator">.</div><div class="ident">ClustersForOrganizationEndpoint</div><div class="operator">,</div>
		<div class="ident">orgID</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><h1>nosec G107</h1>
</td>
	<td class="code"><pre><code>	<div class="ident">response</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">Get</div><div class="operator">(</div><div class="ident">aggregatorURL</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">var</div> <div class="ident">recvMsg</div> <div class="keyword">struct</div> <div class="operator">{</div>
		<div class="ident">Status</div>   <div class="ident">string</div>              <div class="literal">`json:&#34;status&#34;`</div><div class="operator"></div>
		<div class="ident">Clusters</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div> <div class="literal">`json:&#34;clusters&#34;`</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">json</div><div class="operator">.</div><div class="ident">NewDecoder</div><div class="operator">(</div><div class="ident">response</div><div class="operator">.</div><div class="ident">Body</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Decode</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">recvMsg</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">recvMsg</div><div class="operator">.</div><div class="ident">Clusters</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>readAggregatorReportForClusterID reads report from aggregator,
handles errors by sending corresponding message to the user.
Returns report and bool value set to true if there was no errors</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">readAggregatorReportForClusterID</div><div class="operator">(</div>
	<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">clusterID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div> <div class="ident">userID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div> <div class="ident">writer</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">ResponseWriter</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ReportResponse</div><div class="operator">,</div> <div class="ident">bool</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">aggregatorURL</div> <div class="operator">:=</div> <div class="ident">httputils</div><div class="operator">.</div><div class="ident">MakeURLToEndpoint</div><div class="operator">(</div>
		<div class="ident">server</div><div class="operator">.</div><div class="ident">ServicesConfig</div><div class="operator">.</div><div class="ident">AggregatorBaseEndpoint</div><div class="operator">,</div>
		<div class="ident">ira_server</div><div class="operator">.</div><div class="ident">ReportEndpoint</div><div class="operator">,</div>
		<div class="ident">orgID</div><div class="operator">,</div>
		<div class="ident">clusterID</div><div class="operator">,</div>
		<div class="ident">userID</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><h1>nosec G107</h1>
</td>
	<td class="code"><pre><code>	<div class="ident">aggregatorResp</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">Get</div><div class="operator">(</div><div class="ident">aggregatorURL</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">var</div> <div class="ident">aggregatorResponse</div> <div class="keyword">struct</div> <div class="operator">{</div>
		<div class="ident">Report</div> <div class="operator">*</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ReportResponse</div> <div class="literal">`json:&#34;report&#34;`</div><div class="operator"></div>
		<div class="ident">Status</div> <div class="ident">string</div>                <div class="literal">`json:&#34;status&#34;`</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">responseBytes</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">ioutil</div><div class="operator">.</div><div class="ident">ReadAll</div><div class="operator">(</div><div class="ident">aggregatorResp</div><div class="operator">.</div><div class="ident">Body</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">aggregatorResp</div><div class="operator">.</div><div class="ident">StatusCode</div> <div class="operator">!=</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">StatusOK</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">responses</div><div class="operator">.</div><div class="ident">Send</div><div class="operator">(</div><div class="ident">aggregatorResp</div><div class="operator">.</div><div class="ident">StatusCode</div><div class="operator">,</div> <div class="ident">writer</div><div class="operator">,</div> <div class="ident">responseBytes</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">responseDataError</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">json</div><div class="operator">.</div><div class="ident">Unmarshal</div><div class="operator">(</div><div class="ident">responseBytes</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">aggregatorResponse</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">aggregatorResponse</div><div class="operator">.</div><div class="ident">Report</div><div class="operator">,</div> <div class="ident">true</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">readAggregatorReportForClusterList</div><div class="operator">(</div>
	<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">clusterList</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">,</div> <div class="ident">writer</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">ResponseWriter</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReports</div><div class="operator">,</div> <div class="ident">bool</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">clist</div> <div class="operator">:=</div> <div class="ident">strings</div><div class="operator">.</div><div class="ident">Join</div><div class="operator">(</div><div class="ident">clusterList</div><div class="operator">,</div> <div class="literal">&#34;,&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">aggregatorURL</div> <div class="operator">:=</div> <div class="ident">httputils</div><div class="operator">.</div><div class="ident">MakeURLToEndpoint</div><div class="operator">(</div>
		<div class="ident">server</div><div class="operator">.</div><div class="ident">ServicesConfig</div><div class="operator">.</div><div class="ident">AggregatorBaseEndpoint</div><div class="operator">,</div>
		<div class="ident">ira_server</div><div class="operator">.</div><div class="ident">ReportForListOfClustersEndpoint</div><div class="operator">,</div>
		<div class="ident">orgID</div><div class="operator">,</div>
		<div class="ident">clist</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><h1>nosec G107</h1>
</td>
	<td class="code"><pre><code>	<div class="ident">aggregatorResp</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">Get</div><div class="operator">(</div><div class="ident">aggregatorURL</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">var</div> <div class="ident">aggregatorResponse</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReports</div><div class="operator"></div>

	<div class="ident">responseBytes</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">ioutil</div><div class="operator">.</div><div class="ident">ReadAll</div><div class="operator">(</div><div class="ident">aggregatorResp</div><div class="operator">.</div><div class="ident">Body</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">aggregatorResp</div><div class="operator">.</div><div class="ident">StatusCode</div> <div class="operator">!=</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">StatusOK</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">responses</div><div class="operator">.</div><div class="ident">Send</div><div class="operator">(</div><div class="ident">aggregatorResp</div><div class="operator">.</div><div class="ident">StatusCode</div><div class="operator">,</div> <div class="ident">writer</div><div class="operator">,</div> <div class="ident">responseBytes</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">responseDataError</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">json</div><div class="operator">.</div><div class="ident">Unmarshal</div><div class="operator">(</div><div class="ident">responseBytes</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">aggregatorResponse</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="operator">&amp;</div><div class="ident">aggregatorResponse</div><div class="operator">,</div> <div class="ident">true</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>readAggregatorRuleForClusterID reads report from aggregator,
handles errors by sending corresponding message to the user.
Returns report and bool value set to true if there was no errors</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">readAggregatorRuleForClusterID</div><div class="operator">(</div>
	<div class="ident">orgID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">,</div> <div class="ident">clusterID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div> <div class="ident">userID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">UserID</div><div class="operator">,</div> <div class="ident">ruleID</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">RuleID</div><div class="operator">,</div> <div class="ident">errorKey</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ErrorKey</div><div class="operator">,</div> <div class="ident">writer</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">ResponseWriter</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RuleOnReport</div><div class="operator">,</div> <div class="ident">bool</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">aggregatorURL</div> <div class="operator">:=</div> <div class="ident">httputils</div><div class="operator">.</div><div class="ident">MakeURLToEndpoint</div><div class="operator">(</div>
		<div class="ident">server</div><div class="operator">.</div><div class="ident">ServicesConfig</div><div class="operator">.</div><div class="ident">AggregatorBaseEndpoint</div><div class="operator">,</div>
		<div class="ident">ira_server</div><div class="operator">.</div><div class="ident">RuleEndpoint</div><div class="operator">,</div>
		<div class="ident">orgID</div><div class="operator">,</div>
		<div class="ident">clusterID</div><div class="operator">,</div>
		<div class="ident">userID</div><div class="operator">,</div>
		<div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprintf</div><div class="operator">(</div><div class="literal">&#34;%v|%v&#34;</div><div class="operator">,</div> <div class="ident">ruleID</div><div class="operator">,</div> <div class="ident">errorKey</div><div class="operator">)</div><div class="operator">,</div>
	<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><h1>nosec G107</h1>
</td>
	<td class="code"><pre><code>	<div class="ident">aggregatorResp</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">Get</div><div class="operator">(</div><div class="ident">aggregatorURL</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">var</div> <div class="ident">aggregatorResponse</div> <div class="keyword">struct</div> <div class="operator">{</div>
		<div class="ident">Report</div> <div class="operator">*</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RuleOnReport</div> <div class="literal">`json:&#34;report&#34;`</div><div class="operator"></div>
		<div class="ident">Status</div> <div class="ident">string</div>              <div class="literal">`json:&#34;status&#34;`</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">responseBytes</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">ioutil</div><div class="operator">.</div><div class="ident">ReadAll</div><div class="operator">(</div><div class="ident">aggregatorResp</div><div class="operator">.</div><div class="ident">Body</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">aggregatorResp</div><div class="operator">.</div><div class="ident">StatusCode</div> <div class="operator">!=</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">StatusOK</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">responses</div><div class="operator">.</div><div class="ident">Send</div><div class="operator">(</div><div class="ident">aggregatorResp</div><div class="operator">.</div><div class="ident">StatusCode</div><div class="operator">,</div> <div class="ident">writer</div><div class="operator">,</div> <div class="ident">responseBytes</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">responseDataError</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">json</div><div class="operator">.</div><div class="ident">Unmarshal</div><div class="operator">(</div><div class="ident">responseBytes</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">aggregatorResponse</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">aggregatorResponse</div><div class="operator">.</div><div class="ident">Report</div><div class="operator">,</div> <div class="ident">true</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">fetchAggregatorReport</div><div class="operator">(</div>
	<div class="ident">writer</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">ResponseWriter</div><div class="operator">,</div> <div class="ident">request</div> <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Request</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ReportResponse</div><div class="operator">,</div> <div class="ident">bool</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">clusterID</div><div class="operator">,</div> <div class="ident">successful</div> <div class="operator">:=</div> <div class="ident">httputils</div><div class="operator">.</div><div class="ident">ReadClusterName</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Error message handled by function</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="operator">!</div><div class="ident">successful</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">authToken</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">GetAuthToken</div><div class="operator">(</div><div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">userID</div> <div class="operator">:=</div> <div class="ident">authToken</div><div class="operator">.</div><div class="ident">AccountNumber</div><div class="operator"></div>
	<div class="ident">orgID</div> <div class="operator">:=</div> <div class="ident">authToken</div><div class="operator">.</div><div class="ident">Internal</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator"></div>

	<div class="ident">aggregatorResponse</div><div class="operator">,</div> <div class="ident">successful</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">readAggregatorReportForClusterID</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterID</div><div class="operator">,</div> <div class="ident">userID</div><div class="operator">,</div> <div class="ident">writer</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="operator">!</div><div class="ident">successful</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">aggregatorResponse</div><div class="operator">,</div> <div class="ident">true</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>fetchAggregatorReports method access the Insights Results Aggregator to read
reports for given list of clusters. Then the response structure is
constructed from data returned by Aggregator.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">fetchAggregatorReports</div><div class="operator">(</div>
	<div class="ident">writer</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">ResponseWriter</div><div class="operator">,</div> <div class="ident">request</div> <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Request</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReports</div><div class="operator">,</div> <div class="ident">bool</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>cluster list is specified in path (part of URL)</p>
</td>
	<td class="code"><pre><code>	<div class="ident">clusterList</div><div class="operator">,</div> <div class="ident">successful</div> <div class="operator">:=</div> <div class="ident">httputils</div><div class="operator">.</div><div class="ident">ReadClusterListFromPath</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Error message handled by function</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="operator">!</div><div class="ident">successful</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">authToken</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">GetAuthToken</div><div class="operator">(</div><div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">orgID</div> <div class="operator">:=</div> <div class="ident">authToken</div><div class="operator">.</div><div class="ident">Internal</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator"></div>

	<div class="ident">aggregatorResponse</div><div class="operator">,</div> <div class="ident">successful</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">readAggregatorReportForClusterList</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterList</div><div class="operator">,</div> <div class="ident">writer</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="operator">!</div><div class="ident">successful</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">aggregatorResponse</div><div class="operator">,</div> <div class="ident">true</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>fetchAggregatorReportsUsingRequestBodyClusterList method access the Insights
Results Aggregator to read reports for given list of clusters. Then the
response structure is constructed from data returned by Aggregator.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">fetchAggregatorReportsUsingRequestBodyClusterList</div><div class="operator">(</div>
	<div class="ident">writer</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">ResponseWriter</div><div class="operator">,</div> <div class="ident">request</div> <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Request</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterReports</div><div class="operator">,</div> <div class="ident">bool</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>cluster list is specified in request body</p>
</td>
	<td class="code"><pre><code>	<div class="ident">clusterList</div><div class="operator">,</div> <div class="ident">successful</div> <div class="operator">:=</div> <div class="ident">httputils</div><div class="operator">.</div><div class="ident">ReadClusterListFromBody</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Error message handled by function</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="operator">!</div><div class="ident">successful</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">authToken</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">GetAuthToken</div><div class="operator">(</div><div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">orgID</div> <div class="operator">:=</div> <div class="ident">authToken</div><div class="operator">.</div><div class="ident">Internal</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator"></div>

	<div class="ident">aggregatorResponse</div><div class="operator">,</div> <div class="ident">successful</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">readAggregatorReportForClusterList</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterList</div><div class="operator">,</div> <div class="ident">writer</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="operator">!</div><div class="ident">successful</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">aggregatorResponse</div><div class="operator">,</div> <div class="ident">true</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">reportEndpoint</div><div class="operator">(</div><div class="ident">writer</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">ResponseWriter</div><div class="operator">,</div> <div class="ident">request</div> <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Request</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">aggregatorResponse</div><div class="operator">,</div> <div class="ident">successful</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">fetchAggregatorReport</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="operator">!</div><div class="ident">successful</div> <div class="operator">{</div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">includeDisabled</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">readGetDisabledParam</div><div class="operator">(</div><div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">osdFlag</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">readOSDEligible</div><div class="operator">(</div><div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;Got error while parsing `%s` value&#34;</div><div class="operator">,</div> <div class="ident">OSDEligibleParam</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;%s flag = %t&#34;</div><div class="operator">,</div> <div class="ident">GetDisabledParam</div><div class="operator">,</div> <div class="ident">includeDisabled</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;%s flag = %t&#34;</div><div class="operator">,</div> <div class="ident">OSDEligibleParam</div><div class="operator">,</div> <div class="ident">osdFlag</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">rules</div><div class="operator">,</div> <div class="ident">disabledRules</div><div class="operator">,</div> <div class="ident">rulesWithoutContent</div> <div class="operator">:=</div> <div class="ident">filterRulesResponse</div><div class="operator">(</div><div class="ident">aggregatorResponse</div><div class="operator">.</div><div class="ident">Report</div><div class="operator">,</div> <div class="ident">osdFlag</div><div class="operator">,</div> <div class="ident">includeDisabled</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">report</div> <div class="operator">:=</div> <div class="ident">proxy_types</div><div class="operator">.</div><div class="ident">SmartProxyReport</div><div class="operator">{</div>
		<div class="ident">Meta</div><div class="operator">:</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ReportResponseMeta</div><div class="operator">{</div>
			<div class="ident">LastCheckedAt</div><div class="operator">:</div> <div class="ident">aggregatorResponse</div><div class="operator">.</div><div class="ident">Meta</div><div class="operator">.</div><div class="ident">LastCheckedAt</div><div class="operator">,</div>
			<div class="ident">Count</div><div class="operator">:</div>         <div class="ident">len</div><div class="operator">(</div><div class="ident">rules</div><div class="operator">)</div> <div class="operator">&#43;</div> <div class="ident">rulesWithoutContent</div><div class="operator">,</div>
		<div class="operator">}</div><div class="operator">,</div>
		<div class="ident">Data</div><div class="operator">:</div> <div class="ident">rules</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">status</div> <div class="operator">:=</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">StatusOK</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>This condition checks that the only rules for the cluster have missing content</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">rulesWithoutContent</div> <div class="operator">&gt;</div> <div class="literal">0</div> <div class="operator">&amp;&amp;</div> <div class="ident">len</div><div class="operator">(</div><div class="ident">rules</div><div class="operator">)</div> <div class="operator">==</div> <div class="literal">0</div> <div class="operator">&amp;&amp;</div> <div class="ident">disabledRules</div> <div class="operator">==</div> <div class="literal">0</div> <div class="operator">{</div>
		<div class="ident">status</div> <div class="operator">=</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">StatusInternalServerError</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">responses</div><div class="operator">.</div><div class="ident">Send</div><div class="operator">(</div><div class="ident">status</div><div class="operator">,</div> <div class="ident">writer</div><div class="operator">,</div> <div class="ident">responses</div><div class="operator">.</div><div class="ident">BuildOkResponseWithData</div><div class="operator">(</div><div class="literal">&#34;report&#34;</div><div class="operator">,</div> <div class="ident">report</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">responseDataError</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>reportForListOfClustersEndpoint is a handler that returns reports for
several clusters that all need to belong to one organization specified in
request path. List of clusters is specified in request path as well which
means that clients needs to deal with URL limit (around 2000 characters).</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">reportForListOfClustersEndpoint</div><div class="operator">(</div><div class="ident">writer</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">ResponseWriter</div><div class="operator">,</div> <div class="ident">request</div> <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Request</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to read results from Insights Results Aggregator service</p>
</td>
	<td class="code"><pre><code>	<div class="ident">aggregatorResponse</div><div class="operator">,</div> <div class="ident">successful</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">fetchAggregatorReports</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="operator">!</div><div class="ident">successful</div> <div class="operator">{</div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>send the response back to client</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">responses</div><div class="operator">.</div><div class="ident">Send</div><div class="operator">(</div><div class="ident">http</div><div class="operator">.</div><div class="ident">StatusOK</div><div class="operator">,</div> <div class="ident">writer</div><div class="operator">,</div> <div class="ident">aggregatorResponse</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">responseDataError</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>reportForListOfClustersPayloadEndpoint is a handler that returns reports for
several clusters that all need to belong to one organization specified in
request path. List of clusters is specified in request body which means that
clients can use as many cluster ID as the wont without any (real) limits.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">reportForListOfClustersPayloadEndpoint</div><div class="operator">(</div><div class="ident">writer</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">ResponseWriter</div><div class="operator">,</div> <div class="ident">request</div> <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Request</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to read results from Insights Results Aggregator service</p>
</td>
	<td class="code"><pre><code>	<div class="ident">aggregatorResponse</div><div class="operator">,</div> <div class="ident">successful</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">fetchAggregatorReportsUsingRequestBodyClusterList</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="operator">!</div><div class="ident">successful</div> <div class="operator">{</div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>send the response back to client</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">responses</div><div class="operator">.</div><div class="ident">Send</div><div class="operator">(</div><div class="ident">http</div><div class="operator">.</div><div class="ident">StatusOK</div><div class="operator">,</div> <div class="ident">writer</div><div class="operator">,</div> <div class="ident">aggregatorResponse</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">responseDataError</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">fetchAggregatorReportRule</div><div class="operator">(</div>
	<div class="ident">writer</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">ResponseWriter</div><div class="operator">,</div> <div class="ident">request</div> <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Request</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RuleOnReport</div><div class="operator">,</div> <div class="ident">bool</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">clusterID</div><div class="operator">,</div> <div class="ident">successful</div> <div class="operator">:=</div> <div class="ident">httputils</div><div class="operator">.</div><div class="ident">ReadClusterName</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Error message handled by function</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="operator">!</div><div class="ident">successful</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">ruleID</div><div class="operator">,</div> <div class="ident">errorKey</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">readRuleIDWithErrorKey</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">authToken</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">GetAuthToken</div><div class="operator">(</div><div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">userID</div> <div class="operator">:=</div> <div class="ident">authToken</div><div class="operator">.</div><div class="ident">AccountNumber</div><div class="operator"></div>
	<div class="ident">orgID</div> <div class="operator">:=</div> <div class="ident">authToken</div><div class="operator">.</div><div class="ident">Internal</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator"></div>

	<div class="ident">aggregatorResponse</div><div class="operator">,</div> <div class="ident">successful</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">readAggregatorRuleForClusterID</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterID</div><div class="operator">,</div> <div class="ident">userID</div><div class="operator">,</div> <div class="ident">ruleID</div><div class="operator">,</div> <div class="ident">errorKey</div><div class="operator">,</div> <div class="ident">writer</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="operator">!</div><div class="ident">successful</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">false</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">aggregatorResponse</div><div class="operator">,</div> <div class="ident">true</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">singleRuleEndpoint</div><div class="operator">(</div><div class="ident">writer</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">ResponseWriter</div><div class="operator">,</div> <div class="ident">request</div> <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Request</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">rule</div> <div class="operator">*</div><div class="ident">proxy_types</div><div class="operator">.</div><div class="ident">RuleWithContentResponse</div><div class="operator"></div>
	<div class="keyword">var</div> <div class="ident">err</div> <div class="ident">error</div><div class="operator"></div>

	<div class="ident">aggregatorResponse</div><div class="operator">,</div> <div class="ident">successful</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">fetchAggregatorReportRule</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Error message handled by function</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="operator">!</div><div class="ident">successful</div> <div class="operator">{</div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">osdFlag</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">readOSDEligible</div><div class="operator">(</div><div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;Got error while parsing `%s` value&#34;</div><div class="operator">,</div> <div class="ident">OSDEligibleParam</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">rule</div><div class="operator">,</div> <div class="ident">successful</div><div class="operator">,</div> <div class="ident">_</div> <div class="operator">=</div> <div class="ident">content</div><div class="operator">.</div><div class="ident">FetchRuleContent</div><div class="operator">(</div><div class="operator">*</div><div class="ident">aggregatorResponse</div><div class="operator">,</div> <div class="ident">osdFlag</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="operator">!</div><div class="ident">successful</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">responses</div><div class="operator">.</div><div class="ident">SendNotFound</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="literal">&#34;Rule was not found&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">rule</div><div class="operator">.</div><div class="ident">Internal</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">checkInternalRulePermissions</div><div class="operator">(</div><div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">handleServerError</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">responses</div><div class="operator">.</div><div class="ident">SendOK</div><div class="operator">(</div><div class="ident">writer</div><div class="operator">,</div> <div class="ident">responses</div><div class="operator">.</div><div class="ident">BuildOkResponseWithData</div><div class="operator">(</div><div class="literal">&#34;report&#34;</div><div class="operator">,</div> <div class="operator">*</div><div class="ident">rule</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">responseDataError</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>checkInternalRulePermissions method checks if organizations for internal
rules are enabled if so, retrieves the org_id from request/token and returns
whether that ID is on the list of allowed organizations to access internal
rules</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">checkInternalRulePermissions</div><div class="operator">(</div><div class="ident">request</div> <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Request</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="keyword">if</div> <div class="operator">!</div><div class="ident">server</div><div class="operator">.</div><div class="ident">Config</div><div class="operator">.</div><div class="ident">EnableInternalRulesOrganizations</div> <div class="operator">||</div> <div class="operator">!</div><div class="ident">server</div><div class="operator">.</div><div class="ident">Config</div><div class="operator">.</div><div class="ident">Auth</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">authToken</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">GetAuthToken</div><div class="operator">(</div><div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">requestOrgID</div> <div class="operator">:=</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">(</div><div class="ident">authToken</div><div class="operator">.</div><div class="ident">Internal</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;Checking internal rule permissions for Organization ID: %v&#34;</div><div class="operator">,</div> <div class="ident">requestOrgID</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">allowedID</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">Config</div><div class="operator">.</div><div class="ident">InternalRulesOrganizations</div> <div class="operator">{</div>
		<div class="keyword">if</div> <div class="ident">requestOrgID</div> <div class="operator">==</div> <div class="ident">allowedID</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;Organization %v is allowed access to internal rules&#34;</div><div class="operator">,</div> <div class="ident">requestOrgID</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>If the loop ends without returning nil, then an authentication error should be raised</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">const</div> <div class="ident">message</div> <div class="operator">=</div> <div class="literal">&#34;This organization is not allowed to access this recommendation&#34;</div><div class="operator"></div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">message</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="operator">&amp;</div><div class="ident">AuthenticationError</div><div class="operator">{</div><div class="ident">errString</div><div class="operator">:</div> <div class="ident">message</div><div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">newExtractUserIDFromTokenToURLRequestModifier</div><div class="operator">(</div><div class="ident">newEndpoint</div> <div class="ident">string</div><div class="operator">)</div> <div class="ident">RequestModifier</div> <div class="operator">{</div>
	<div class="keyword">return</div> <div class="keyword">func</div><div class="operator">(</div><div class="ident">request</div> <div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Request</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">http</div><div class="operator">.</div><div class="ident">Request</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="ident">identity</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">GetAuthToken</div><div class="operator">(</div><div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">vars</div> <div class="operator">:=</div> <div class="ident">mux</div><div class="operator">.</div><div class="ident">Vars</div><div class="operator">(</div><div class="ident">request</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">vars</div><div class="operator">[</div><div class="literal">&#34;user_id&#34;</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">identity</div><div class="operator">.</div><div class="ident">AccountNumber</div><div class="operator">)</div><div class="operator"></div>

		<div class="ident">newURL</div> <div class="operator">:=</div> <div class="ident">httputils</div><div class="operator">.</div><div class="ident">MakeURLToEndpointMapString</div><div class="operator">(</div><div class="ident">server</div><div class="operator">.</div><div class="ident">Config</div><div class="operator">.</div><div class="ident">APIPrefix</div><div class="operator">,</div> <div class="ident">newEndpoint</div><div class="operator">,</div> <div class="ident">vars</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">request</div><div class="operator">.</div><div class="ident">URL</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">url</div><div class="operator">.</div><div class="ident">Parse</div><div class="operator">(</div><div class="ident">newURL</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">ParamsParsingError</div><div class="operator">{</div><div class="operator">}</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">request</div><div class="operator">.</div><div class="ident">RequestURI</div> <div class="operator">=</div> <div class="ident">request</div><div class="operator">.</div><div class="ident">URL</div><div class="operator">.</div><div class="ident">RequestURI</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

		<div class="keyword">return</div> <div class="ident">request</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="operator">(</div><div class="ident">server</div> <div class="ident">HTTPServer</div><div class="operator">)</div> <div class="ident">getOverviewPerCluster</div><div class="operator">(</div>
	<div class="ident">clusterName</div> <div class="ident">types</div><div class="operator">.</div><div class="ident">ClusterName</div><div class="operator">,</div>
	<div class="ident">authToken</div> <div class="operator">*</div><div class="ident">types</div><div class="operator">.</div><div class="ident">Identity</div><div class="operator">,</div>
	<div class="ident">writer</div> <div class="ident">http</div><div class="operator">.</div><div class="ident">ResponseWriter</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">proxy_types</div><div class="operator">.</div><div class="ident">ClusterOverview</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>

	<div class="ident">userID</div> <div class="operator">:=</div> <div class="ident">authToken</div><div class="operator">.</div><div class="ident">AccountNumber</div><div class="operator"></div>
	<div class="ident">orgID</div> <div class="operator">:=</div> <div class="ident">authToken</div><div class="operator">.</div><div class="ident">Internal</div><div class="operator">.</div><div class="ident">OrgID</div><div class="operator"></div>
	<div class="ident">aggregatorResponse</div><div class="operator">,</div> <div class="ident">successful</div> <div class="operator">:=</div> <div class="ident">server</div><div class="operator">.</div><div class="ident">readAggregatorReportForClusterID</div><div class="operator">(</div><div class="ident">orgID</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">,</div> <div class="ident">userID</div><div class="operator">,</div> <div class="ident">writer</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="operator">!</div><div class="ident">successful</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;Aggregator doesn&#39;t have reports for cluster ID %s&#34;</div><div class="operator">,</div> <div class="ident">clusterName</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">aggregatorResponse</div><div class="operator">.</div><div class="ident">Meta</div><div class="operator">.</div><div class="ident">Count</div> <div class="operator">==</div> <div class="literal">0</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;Cluster report doesn&#39;t have any hits. Skipping from overview.&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">totalRisks</div> <div class="operator">:=</div> <div class="ident">make</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">int</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">tags</div> <div class="operator">:=</div> <div class="ident">make</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">rule</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">aggregatorResponse</div><div class="operator">.</div><div class="ident">Report</div> <div class="operator">{</div>
		<div class="ident">ruleID</div> <div class="operator">:=</div> <div class="ident">rule</div><div class="operator">.</div><div class="ident">Module</div><div class="operator"></div>
		<div class="ident">errorKey</div> <div class="operator">:=</div> <div class="ident">rule</div><div class="operator">.</div><div class="ident">ErrorKey</div><div class="operator"></div>
		<div class="ident">ruleWithContent</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">content</div><div class="operator">.</div><div class="ident">GetRuleWithErrorKeyContent</div><div class="operator">(</div><div class="ident">ruleID</div><div class="operator">,</div> <div class="ident">errorKey</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msgf</div><div class="operator">(</div><div class="literal">&#34;Unable to retrieve content for rule %v|%v&#34;</div><div class="operator">,</div> <div class="ident">ruleID</div><div class="operator">,</div> <div class="ident">errorKey</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>this rule is not visible in OCM UI either, so we can continue calculating to be consistent</p>
</td>
	<td class="code"><pre><code>			<div class="keyword">continue</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">totalRisks</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">totalRisks</div><div class="operator">,</div> <div class="ident">ruleWithContent</div><div class="operator">.</div><div class="ident">TotalRisk</div><div class="operator">)</div><div class="operator"></div>

		<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">tag</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">ruleWithContent</div><div class="operator">.</div><div class="ident">Tags</div> <div class="operator">{</div>
			<div class="ident">tags</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">tags</div><div class="operator">,</div> <div class="ident">tag</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="operator">&amp;</div><div class="ident">proxy_types</div><div class="operator">.</div><div class="ident">ClusterOverview</div><div class="operator">{</div>
		<div class="ident">TotalRisksHit</div><div class="operator">:</div> <div class="ident">totalRisks</div><div class="operator">,</div>
		<div class="ident">TagsHit</div><div class="operator">:</div>       <div class="ident">tags</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>filterRulesResponse returns an array of RuleWithContentResponse with only the rules that matches 3 criteria:
- The rule has content from the content-service
- The disabled filter is not match
- The OSD elegible filter is not match</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">filterRulesResponse</div><div class="operator">(</div><div class="ident">aggregatorReport</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">types</div><div class="operator">.</div><div class="ident">RuleOnReport</div><div class="operator">,</div> <div class="ident">filterOSD</div><div class="operator">,</div> <div class="ident">getDisabled</div> <div class="ident">bool</div><div class="operator">)</div> <div class="operator">(</div>
	<div class="ident">filteredRules</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">proxy_types</div><div class="operator">.</div><div class="ident">RuleWithContentResponse</div><div class="operator">,</div>
	<div class="ident">disabledRules</div> <div class="ident">int</div><div class="operator">,</div>
	<div class="ident">noContentRules</div> <div class="ident">int</div><div class="operator">,</div>
<div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Debug</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Bool</div><div class="operator">(</div><div class="ident">GetDisabledParam</div><div class="operator">,</div> <div class="ident">getDisabled</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Bool</div><div class="operator">(</div><div class="ident">OSDEligibleParam</div><div class="operator">,</div> <div class="ident">filterOSD</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Filtering rules in report&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">filteredRules</div> <div class="operator">=</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">proxy_types</div><div class="operator">.</div><div class="ident">RuleWithContentResponse</div><div class="operator">{</div><div class="operator">}</div><div class="operator"></div>
	<div class="ident">disabledRules</div> <div class="operator">=</div> <div class="literal">0</div><div class="operator"></div>
	<div class="ident">noContentRules</div> <div class="operator">=</div> <div class="literal">0</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">aggregatorRule</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">aggregatorReport</div> <div class="operator">{</div>
		<div class="keyword">if</div> <div class="ident">aggregatorRule</div><div class="operator">.</div><div class="ident">Disabled</div> <div class="operator">&amp;&amp;</div> <div class="operator">!</div><div class="ident">getDisabled</div> <div class="operator">{</div>
			<div class="ident">disabledRules</div><div class="operator">&#43;&#43;</div><div class="operator"></div>
			<div class="keyword">continue</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">rule</div><div class="operator">,</div> <div class="ident">successful</div><div class="operator">,</div> <div class="ident">filtered</div> <div class="operator">:=</div> <div class="ident">content</div><div class="operator">.</div><div class="ident">FetchRuleContent</div><div class="operator">(</div><div class="ident">aggregatorRule</div><div class="operator">,</div> <div class="ident">filterOSD</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="operator">!</div><div class="ident">successful</div> <div class="operator">{</div>
			<div class="keyword">if</div> <div class="operator">!</div><div class="ident">filtered</div> <div class="operator">{</div>
				<div class="ident">noContentRules</div><div class="operator">&#43;&#43;</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
			<div class="keyword">continue</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">filteredRules</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">filteredRules</div><div class="operator">,</div> <div class="operator">*</div><div class="ident">rule</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
    </tbody>
  </table>
</div>
</body>
</html>
